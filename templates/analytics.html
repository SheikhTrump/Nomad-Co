<!-- templates\analytics.html -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Dashboard - NomadNest</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { 
            font-family: 'Inter', sans-serif;
            background-color: #0c5461; 
            color: #d1d5db;
        }
        .card {
            background-color: #1f2937;
            border: 1px solid #374151;
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(70, 224, 193, 0.1), 0 4px 6px -2px rgba(70, 224, 193, 0.05);
        }
        .btn-nav {
            background-color: #374151;
            color: #d1d5db;
        }
        .btn-nav:hover {
            background-color: #4b5563;
        }
    </style>
</head>
<body class="min-h-screen">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        
        <!-- Header Section -->
        <div class="flex justify-between items-center mb-10">
            <div>
                <h1 class="text-3xl font-bold text-white">NomadNest Analytics</h1>
                <p class="text-gray-400 mt-1">An overview of platform performance.</p>
            </div>
            <a class="btn-nav py-2 px-4 rounded-lg font-semibold transition-colors duration-200" href="{{ url_for('auth.dashboard') }}">
                <i class="fas fa-arrow-left mr-2"></i>Back to Dashboard
            </a>
        </div>

        <!-- Top Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 mb-10">
            <div class="card rounded-xl p-6 text-center stat-card transition-transform duration-200">
                <i class="fas fa-users fa-3x text-blue-400 mb-3"></i>
                <h5 class="text-lg font-semibold text-gray-400">Total Users</h5>
                <p class="text-5xl font-bold text-white mt-1">{{ user_data.total_users }}</p>
            </div>
            <div class="card rounded-xl p-6 text-center stat-card transition-transform duration-200">
                <i class="fas fa-book-open fa-3x text-green-400 mb-3"></i>
                <h5 class="text-lg font-semibold text-gray-400">Total Bookings</h5>
                <p class="text-5xl font-bold text-white mt-1">{{ booking_data.total_bookings }}</p>
            </div>
            <div class="card rounded-xl p-6 text-center stat-card transition-transform duration-200">
                <i class="fas fa-dollar-sign fa-3x text-yellow-400 mb-3"></i>
                <h5 class="text-lg font-semibold text-gray-400">Total Revenue</h5>
                <p class="text-5xl font-bold text-white mt-1">à§³{{ "{:,.0f}".format(booking_data.total_revenue) }}</p>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-10">
            <div class="card rounded-xl p-6">
                <h5 class="text-xl font-bold text-white mb-4">Users by Role</h5>
                <canvas id="userRoleChart"></canvas>
            </div>
            <div class="card rounded-xl p-6">
                <h5 class="text-xl font-bold text-white mb-4">Bookings by City</h5>
                <canvas id="bookingsByCityChart"></canvas>
            </div>
        </div>

        <!-- Recent Activity Tables -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="card rounded-xl p-6">
                <h5 class="text-xl font-bold text-white mb-4">Recent Signups</h5>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <tbody>
                        {% for user in recent_users %}
                            <tr class="border-b border-gray-700 last:border-b-0">
                                <td class="py-3 pr-3">{{ user.first_name }} {{ user.last_name }}</td>
                                <td class="py-3 px-3 text-gray-400">{{ user.email }}</td>
                                <td class="py-3 pl-3 text-right"><span class="px-2 py-1 text-xs font-semibold rounded-full {{ 'bg-blue-900/50 text-blue-300' if user.role == 'traveler' else 'bg-green-900/50 text-green-300' }}">{{ user.role }}</span></td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card rounded-xl p-6">
                <h5 class="text-xl font-bold text-white mb-4">Recent Bookings</h5>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <tbody>
                        {% for booking in recent_bookings %}
                            <tr class="border-b border-gray-700 last:border-b-0">
                                <td class="py-3 pr-3">{{ booking.space_title }}</td>
                                <td class="py-3 px-3 text-gray-400">{{ booking.check_in_date }}</td>
                                <td class="py-3 pl-3 text-right"><span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-900/50 text-green-300">{{ booking.status }}</span></td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Data from Flask for the charts
        const userData = {{ user_data | tojson | safe }};
        const bookingData = {{ booking_data | tojson | safe }};

        // Chart.js Global Config for dark theme
        Chart.defaults.color = 'rgba(209, 213, 219, 0.7)'; // text-gray-300 with opacity
        Chart.defaults.borderColor = 'rgba(55, 65, 81, 0.5)'; // border-gray-700 with opacity

        // User Role Chart (Doughnut Chart)
        const userRoleCtx = document.getElementById('userRoleChart').getContext('2d');
        new Chart(userRoleCtx, {
            type: 'doughnut',
            data: {
                labels: ['Travelers', 'Hosts'],
                datasets: [{
                    label: 'User Roles',
                    data: [userData.traveler_count, userData.host_count],
                    backgroundColor: ['#60a5fa', '#34d399'], // blue-400, green-400
                    borderColor: '#1f2937', // card background
                    borderWidth: 4
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            font: { size: 14 }
                        }
                    }
                }
            }
        });

        // Bookings by City Chart (Bar Chart)
        const bookingsByCityCtx = document.getElementById('bookingsByCityChart').getContext('2d');
        new Chart(bookingsByCityCtx, {
            type: 'bar',
            data: {
                labels: Object.keys(bookingData.bookings_by_city),
                datasets: [{
                    label: 'Number of Bookings',
                    data: Object.values(bookingData.bookings_by_city),
                    backgroundColor: 'rgba(250, 204, 21, 0.5)', // yellow-400 with opacity
                    borderColor: '#facc15', // yellow-400
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                indexAxis: 'y', // Horizontal bars
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    x: { beginAtZero: true, grid: { color: 'rgba(55, 65, 81, 0.5)' } },
                    y: { grid: { display: false } }
                }
            }
        });
    </script>
</body>
</html>
